# 10|微服务设计：微服务架构与演进

微服务(microservices)是一种软件架构风格，以职责单一、细粒度的小型功能模块为基础，并将这些小型功能模块组合成一个大复杂的大型系统。

## 单体服务 vs 微服务

企业软件的系统架构是由业务驱动的。常见的架构有：

- 按功能对模块进行划分：功能相似的组成一个个功能模块，功能模块之间相互调用。
- 按逻辑对模块进行划分：比如经典的分层设计模式就是MVC结构。

分层设计能够提供统一的开发模式，开发人员容易理解。但是，业务进一步复杂后，分层架构意味着添加或修改业务会涉及到所有层级。

为了解决分层架构的问题，会在分层结构的基础上，按照业务功能做拆分，将各个分层贯穿起来，称为垂直切片(Vertical Slice)。
分离出模块还有一个好处， 模块能够复用到其他单体服务中。

模块与模块之间为了实现低耦合，需要定义明确的接口进行通信。接口应该具有稳定性，职责清晰，并且能够隐藏模块内部的实现细节。

接口可以采用多种方式：

- 同步方式：调用另一个组建库中的公共函数
- 异步方式：中间件发布与订阅、通过共享文件、数据库的方式进行通信等

随着业务复杂度进一步上升，系统复杂度会成指数上升，主要有几个原因：

1. 与最初的设计偏离：参与的人员越多，风格越不同意，越复杂，越难维护
2. 模块耦合：低耦合的模块设计失败，模块与模块之间的依赖关系错综复杂
3. 团队管理、开发效率变低：人越多，工作效率越低

微服务是方法而不是目标，只有当前架构无法实现最终目标时，才需要微服务。

## 微服务的优势

微服务的优势：

- 技术差异性：微服务之间技术架构可以不一致，同时不同的团队之间可以根据问题的特点使用相对应的技术
- 稳健性：使用微服务，当单个组件发生故障时，只要该故障没有级联，就可以隔离问题，确保系统的其他部分正常运行。
- 更易扩容、更灵活：微服务架构可以根据模块的承载能力不同进行更为灵活的扩容
- 团队效率更高：微服务架构能够与小团队的组织架构更加的契合
- 可组合性：更容易组合，代码复用率高

## 微服务的缺点

微服务也不是银子弹，有以下缺点：

- 服务太多，难以开发调试：调用链长，难以定位问题。同时服务的测试难度也会提高
- 延迟增加：对信息进行序列化、网络传输、反序列化等操作增加处理时间。
- 日志的聚合和监控：日志分布在各个微服务当中，需要使用新的手段将日志进行聚合。
- 通用问题：数据一致性、可用性、安全等问题

## 微服务的边界

设计微服务的目的是方便更高效的修改业务功能，所以在设计业务架构时，优先考虑的是业务的高内聚性，将相似的业务功能聚合在同一个微服务中。

微服务应该是一个足够独立的模块。设计微服务边界时，重要的原则就是：“**高内聚、低耦合**”。

- 高内聚：“一起改变的代码，放在一起”。将功能相关的代码聚合到一起，能够帮助我们在尽可能少的地方做修改。
- 低耦合：强调服务与服务之间的关系。在微服务架构中，服务与服务之间的关系应该是松散的、低耦合的。

高内聚和低耦合是一体双面的，更好地实现内聚也能减少服务之间的耦合度，而低耦合也取决于服务与服务之间的沟通模式。对外提供的API应该更可能少，
隐藏内部的实现细节，同时API提供向后兼容的能力。其他服务不需要知道当前服务内部的细节，将当前服务当作一个黑盒。这种服务关注点的分离，能够更好的
驾驭更大规模的程序。

## 微服务的通信

微服务之间的通信从大的方向看有两种：一种是同步通信、一种是异步通信。

同步的方式阻塞等待系统的返回。这是最直接的一种方式，

异步通信的方式可以通过回调、事件驱动和数据共享的方式实现。重点是事件驱动的通信，相较于上游服务主动通知下游服务，
事件驱动的通信将处理数据的责任交给了下游服务。

最特殊的是借助共享的数据库或文件进行通信。通过定时轮训查询数据库中或指定目录下是否有待处理的文件。

## 服务发现与负载均衡

微服务中，服务众多，且可以动态的进行扩容与缩容，服务的地址也是动态变化的。因此需要更灵活的服务发现机制，以便知道当前环境中存在那些服务。

服务发现机制中包含着两部分：1. 服务注册，服务启动时向服务注册中心注册，并定时发送心跳维活；2. 服务发现，服务调用方调用服务注册中心，
发现当前存活的服务的地址。

最基本的两种形式：服务端发现模式和客户端发现模式

### 服务端发现模式

服务端发现模式在调用方和被调用方中间额外增加了代理网关层，代理网关接收到请求后，从服务注册中心获取指定服务的可用节点列表，并根据相应的负载均衡
策略选择一个最终的节点进行访问。开源的HAproxy、Nginx等负载均衡产品都可以作为代理模式的网关服务。

服务端发现模式的优点是：服务调用方不关注发现的细节，服务和监控等策略可以统一在代理网关进行。
服务端发现模式的缺点是：网络中多了一层，部署麻烦，且代理服务容易成为性能瓶颈和出现单点故障。

Kubernetes的Service资源实现服务本质上就是一种服务端发现模式，但是实现方式不一致，Service会生成一个虚拟IP,通过修改iptables的规则，将虚拟
的IP转发到指定Pod的地址中，实现服务发现和负载均衡。

### 客户端发现模式

客户端能够直接从服务注册中心获取可用的节点列表，并可以监听服务节点注册的变化。调用方根据一定的负载均衡策略选择一个最终的服务节点。

两种方式需要根据实际业务场景进行选择，甚至是混合使用。