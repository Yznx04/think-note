# 05|全局视野：洞悉项目开发流程与规范

## 研发实现阶段

发过程需要遵循多种规范。开发规范能够帮助团队更好地协作、同时也能提高代码质量、提高程序的性能、规避低级错误、发现隐含的问题。

### 编码规范

编码规范是最重要的规范，是团队在程序开发过程时需要遵守的约定。好代码需要具备以下特性：

- 整洁、一致
- 高效
- 健壮
- 可扩展

### 接口规范

接口规范指的是定义系统与外界交互方式的规范。服务的上游叫Caller，服务的下游叫callee.

服务之间的通信，最常用的是HTTP、gRPC、Thrift三种。最常用的HTTP规范是RESTful风格的接口。

大公司会单独管理接口，甚至是会有一套专门描述软件接口的语言：IDL(Interface Description Language)。IDL通过独立于编程语言的方式来描述接口
，每种编程语言都会根据IDL生成一套自己语言的SDK。使用IDL的好处有：

- 作为接口说明文档，IDL统一规范了接口定义和使用方法，不同使用方不必反复沟通接口的使用方法
- 不同语言之间可以很方便的相互通信，屏蔽了开发语言上的差异
- 生成的SDK可以提供通用的能力

### 日志规范

日志系统能够提供程序在运行时的状态记录，日志的好处有：

1. 调试打印：用日志来记录变量或一段逻辑
2. 问题定位：对于问题出现的时间、参数等进行查看
3. 用户行为分析：日志信息中包含了用户的操作、行为，可以作为大数据分析的原始材料
4. 监控：日志数据通过流处理的生成连续的数据可以作为指标，并对接告警平台。

### 版本控制规范

代码版本控制系统是现代程序开发中必不可少的组件。

####  Git与工作流

git是当前使用最多的版本控制工具，git最核心的概念是分支。git催生了很多工作流，包括：

- 集中式工作流
- Git Flow工作流
- Github Flow工作流
- Gitlab Flow工作流

##### git flow工作流

git flow工作流对分支有着严格的定义：

- master分支：作为唯一一个正式对外发布的分支，是所有分支中最稳定的
- Develop分支：根据Master分支创建而来。Develop分支作为一种集成分支，专门用来集成已经完成开发的特性
- Feature分支：根据Develop分支创建出来。GitFlow工作流中，每个新特性都有自己的Feature分支。当特性开发完成后，会被合并到Develop分支
- Release分支：当积累了足够多的已完成特性，或者预定的系统发布周期临近时，会从Develop分支新建一个Release分支，专门做和当前版本发布相关的工作。Release分支一经创建，就不允许新特性合入这个分支了，只有BUG修复和编辑文档之类的工作才能够进入该分支。Release分支最终会合入Master分支
- Hotfix分支：直接从Master分支创建。目的是给运行在生产环境中的系统快速提供补丁。当Hotfix分支上所有工作完成以后，可以合并到master.

##### github flow工作流

github flow的工作流程如下：

1. 项目维护者将代码提交到主仓库
2. 开发者Fork主仓库，做出修改
3. 开发者将修改后的代码提交到自己的仓库中
4. 开发者创建PR请求，包括本次修改的相关信息。
5. PR通过后，项目维护者将修改合并到主分支
6. 合并请求拉取后，删除原有分支，防止有人误用旧分支

####  commit规范

Commit规范是一次开发者触发的代码提交,每一次提交Commit提交都有必要的提交信息，规范这些信息有以下好处：

- 格式统一，内容更加清晰和易读
- 可以通过提交记录来了解本次提交的目的，更好的CR和重构
- 更容易了解变更、定位和发现问题
- 由于每个提交的描述都是经过思考的，这就可以改善提交的质量

Go在使用的规范：第一行是变更的简单描述，并在最开始指明了受影响的package, 正文部分详细描述了本轮修改的背景和目的。

还有其他规范，比如Angular用的`[变更类型][作用域]描述`。

## 测试阶段

代码开发完毕后，需要完成必要的测试：

- 代码规范测试：包括对代码风格、命名等的检测，常用的工具有：gofmt、goimport、golangci-lint等
- 代码质量测试：包括代码覆盖率。主要工具有go tool cover
- 代码逻辑测试：包括并发错误测试、新增功能测试。主要工具race、单元测试等。
- 性能测试：包括BenchMark测试、性能对比。主要工具有：benchmark、ab、pprof、trace等
- 服务测试：测试服务接口的功能性与准确性，以及服务的可用性测试
- 系统测试：包括端到端测试，确保上下游接口与参数传递的准确性、确保产品功能符合预期


## 上线部署阶段

提交代码、合入代码后，会进行代码的编译、镜像打包、自动化测试等操作，这些操作将开发与运维结合起来，使用自动、连续和迭代的过程被称为CI/CD。
CI/CD是DevOps的一种最佳实践，通过CI/CD能够提高软件开发和交付的效率、速度和安全性。

上线部署需要遵循以下要求：

- 避免高峰期进行上线操作，避免在节假日之前进行较大的变更
- 提前通报利益相关者，例如：项目组成员、组内成员、有影响的上下游
- 严格规范上线执行步骤、确定检查清单和回滚方案
- 灰度发布，对于变更的功能，采取逐步放量的方式
- 分级发布，遵循先少量，再部分，最后再全量的原则;严格控制每一次部署的时间间隔
- 在上线时进行检查，观察当前服务的指标是否正常，如果发现异常则及时回滚，止损后再查明问题原因
- 上线后，关注告警群，关注上下游的反馈，收集错误日志，并抓取case查看

## 运维阶段

SRE工程师的工作涉及开发工作，通过自动化、工具化等手段提升服务管理效率，确保集群的可观测性、稳定性、可用性。

SRE常见指标：

- MTTI(Mean Time To Identify): 平均故障发现时间。故障发现：监控告警、日常巡检、用户反馈、异常检测
- MTTA(Mean Time To Acknowledge): 平均故障确认时间。故障响应：OnCall、ChatOps、人员互备、故障预案
- MTTL(Mean Time To Location): 平均故障定位时间。故障定位：可观测性、DataOps、事件管理、根因分析
- MTTT(Mean Time To Troubleshooting): 平均故障解决时间。故障解决：故障自愈、服务熔断、降级限流、操作事务
- MTTV(Mean Time To Verfiy): 平均故障验证时间。故障验证：业务验证、监控数据、用户反馈、服务状态

要确定服务是否稳定运行，需要对目标进行量化。所有运维工作都围绕着SLO(服务水平目标)目标的定制、执行、跟踪和反馈来展开。Google有一套VALET方法：

- Volume(容量)：服务承诺的最大容量。常见的包括：QPS、TPS、会话数、吞吐量以及活动连接数等
- Availablity(可用性): 服务是否正常/稳定。
- Latency(时延)：服务响应速度。
- Error(错误率)：服务错误率，比如HTTP5XX、4XX以及自定义的错误码
- Ticket(人工干预)：服务是否需要人工干预，面对一些复杂的故障场景就需要人工干预

## 运营阶段

运营需要评估新功能是否符合预期目标。通过实验的结论和数据的分析，洞悉用户需求变化，进一步策略调整、产品研发提供决策依据。
