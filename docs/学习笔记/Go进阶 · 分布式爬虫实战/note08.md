# 08|高性能设计：自顶向下的高性能Go程序设计和优化

用最小的资源将程序的性能最大化是开发者、公司面临的现实困境。

## 过早设计是万恶之源

过早设计是万恶之源，有三种理解：

1. 不经过思考就进行优化肯定是不对的，这是这句话隐含的第一层意思。开发者应该更多地关注程序中的关键部分，忽略掉不关键的部分。
2. 迟早要对关键代码做优化
3. 在设计阶段进行优化是有必要的

## 性能设计分层抽象

自上而下五个阶段：

- 系统级别
- 程序设计和组织级别
- 代码实施级别
- 操作系统级别
- 硬件级别

### 系统级别

现代大型系统都采用分布式、微服务的系统架构。借助灵活的程序伸缩性快速适应动态的外部变化。

系统级别优化和架构设计的过程息息相关，其考虑的方面在于：“如何对服务进行拆分”、“如何将服务链接在一起”、“服务调用关系及调用频率”。

大型系统集群的性能优化还包括：服务的监控与告警、服务的降级策略（限流、重试、降级、熔断）、分布式追踪、分布式日志收集等手段。

### 程序设计和组织级别

程序内好的设计是构建高性能、可维护程序的基础。程序设计包括了如何完成功能的拆分、流程的抽象、使用何种形式组织代码、定义清晰的模块间的接口边界、
使用何种框架、并发处理模型；甚至包括搭建的开发流程和规范，重点指标体系的设计和监控。

要使程序具备高性能，需要围绕实现的性能目标，选择最佳的高性能方案。

高性能程序设计的常用原则：

1. 流程异步化
2. 执行的关键阶段请求并行化，尽量将串行改为并行。
3. 合理选择与实际系统匹配的并发模型
4. 考虑无锁化与缓存化，保证并发的威力

如何用工具和指标来验证程序实际并行效率？

1. 瞬时协程数大于`GOMAXPROCS`, 也就是当前线程数，才能充分利用CPU,获取瞬时协程数的方式有多种
   1. 借助Debug库中的NumGoRoutine函数，GOMAXPROCS还可以获取逻辑处理器P;
   2. 使用runtime/metrics包，获取运行时metrics,进而获取到协程数量
   3. 通过pprof获取当前的协程数量
2. 分析整个调度器的运行状态，思路有：
   1. 启动GODEBUG特定环境变量方式，查看调度器日志
   2. 通过pprof和trace工具，可视化分析调度器的运行状态
